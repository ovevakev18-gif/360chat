<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>360Chat</title>
<style>
body { font-family: Arial; display: flex; height: 100vh; margin: 0; }
#chats { width: 250px; border-right: 1px solid #ddd; overflow-y: auto; }
#chat { flex: 1; display: flex; flex-direction: column; }
#messages { flex: 1; padding: 10px; overflow-y: auto; }
.me { text-align: right; color: green; }
.them { text-align: left; color: black; }
input { padding: 10px; width: 80%; }
button { padding: 10px; }
.chat-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<div id="chats"></div>

<div id="chat">
  <div id="messages"></div>
  <div>
    <input id="text" placeholder="Type message..." />
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
let currentPhone = null;
const ws = new WebSocket(location.origin.replace('http', 'ws'));

ws.onmessage = () => {
  if (currentPhone) loadMessages(currentPhone);
  loadChats();
};

async function loadChats() {
  const res = await fetch('/api/chats');
  const chats = await res.json();

  const div = document.getElementById('chats');
  div.innerHTML = '';

  chats.forEach(c => {
    const el = document.createElement('div');
    el.className = 'chat-item';
    el.innerText = c.name;
    el.onclick = () => {
      currentPhone = c.phone;
      loadMessages(c.phone);
    };
    div.appendChild(el);
  });
}

async function loadMessages(phone) {
  const res = await fetch('/api/messages/' + phone);
  const msgs = await res.json();

  const div = document.getElementById('messages');
  div.innerHTML = '';

  msgs.forEach(m => {
    const el = document.createElement('div');
    el.className = m.from === 'me' ? 'me' : 'them';
    el.innerText = m.text + ' (' + m.status + ')';
    div.appendChild(el);
  });

  div.scrollTop = div.scrollHeight;
}

async function send() {
  const text = document.getElementById('text').value;
  if (!text || !currentPhone) return;

  await fetch('/api/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone: currentPhone, text })
  });

  document.getElementById('text').value = '';
}

loadChats();
</script>

</body>
</html>
