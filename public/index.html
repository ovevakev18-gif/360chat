<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>360Chat</title>
  <style>
    body { margin: 0; font-family: Arial; display: flex; height: 100vh; }
    #chats { width: 30%; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; }
    .chat-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    .chat-item:hover { background: #f5f5f5; }
    .me { text-align: right; margin: 5px; }
    .them { text-align: left; margin: 5px; }
    #inputArea { position: fixed; bottom: 0; right: 0; width: 70%; display: flex; }
    #text { flex: 1; padding: 10px; }
    button { padding: 10px; }
  </style>
</head>
<body>

<div id="chats"></div>

<div style="flex:1; display:flex; flex-direction:column;">
  <div id="messages" style="flex:1;"></div>

  <div id="inputArea">
    <input id="text" placeholder="Введите сообщение..." />
    <button onclick="send()">Отправить</button>
  </div>
</div>

<script>
let currentPhone = null;
const ws = new WebSocket(location.origin.replace('http', 'ws'));

document.addEventListener("DOMContentLoaded", () => {

  ws.onmessage = () => {
    if (currentPhone) loadMessages(currentPhone);
    loadChats();
  };

  loadChats();
});

async function loadChats() {
  const res = await fetch('/api/chats');
  const chats = await res.json();

  const div = document.getElementById('chats');
  div.innerHTML = '';

  chats.forEach(c => {
    const el = document.createElement('div');
    el.className = 'chat-item';
    el.innerText = c.name + (c.unread ? ' (' + c.unread + ')' : '');
    el.onclick = () => {
      currentPhone = c.phone;
      loadMessages(c.phone);
    };
    div.appendChild(el);
  });
}

async function loadMessages(phone) {
  const res = await fetch('/api/messages/' + phone);
  const msgs = await res.json();

  const div = document.getElementById('messages');
  div.innerHTML = '';

  msgs.forEach(m => {
    const el = document.createElement('div');
    el.className = m.from === 'me' ? 'me' : 'them';
    el.innerText = m.text + ' (' + m.status + ')';
    div.appendChild(el);
  });

  div.scrollTop = div.scrollHeight;
}

async function send() {
  const textInput = document.getElementById('text');
  const text = textInput.value.trim();

  if (!currentPhone) {
    alert('Выберите чат слева');
    return;
  }

  if (!text) return;

  await fetch('/api/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone: currentPhone, text })
  });

  textInput.value = '';
  loadMessages(currentPhone);
}
</script>

</body>
</html>
