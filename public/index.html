<script>
let currentPhone = null;
const ws = new WebSocket(location.origin.replace('http', 'ws'));

ws.onmessage = () => {
  if (currentPhone) loadMessages(currentPhone);
  loadChats();
};

async function loadChats() {
  const res = await fetch('/api/chats');
  const chats = await res.json();

  const div = document.getElementById('chats');
  div.innerHTML = '';

  chats.forEach(c => {
    const el = document.createElement('div');
    el.className = 'chat-item';
    el.innerText = c.name + (c.unread ? ' (' + c.unread + ')' : '');
    el.onclick = () => {
      currentPhone = c.phone;
      loadMessages(c.phone);
    };
    div.appendChild(el);
  });
}

async function loadMessages(phone) {
  const res = await fetch('/api/messages/' + phone);
  const msgs = await res.json();

  const div = document.getElementById('messages');
  div.innerHTML = '';

  msgs.forEach(m => {
    const el = document.createElement('div');
    el.className = m.from === 'me' ? 'me' : 'them';
    el.innerText = m.text + ' (' + m.status + ')';
    div.appendChild(el);
  });

  div.scrollTop = div.scrollHeight;
}

async function send() {
  const textInput = document.getElementById('text');
  const text = textInput.value.trim();

  if (!currentPhone) {
    alert('Выберите чат слева');
    return;
  }

  if (!text) return;

  try {
    const res = await fetch('/api/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: currentPhone, text })
    });

    const data = await res.json();

    if (!res.ok) {
      console.error(data);
      alert('Ошибка отправки');
      return;
    }

    textInput.value = '';
    loadMessages(currentPhone);

  } catch (err) {
    console.error(err);
    alert('Сервер не отвечает');
  }
}

loadChats();
</script>
